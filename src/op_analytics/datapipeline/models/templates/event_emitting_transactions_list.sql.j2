WITH topic0_filters AS ( -- list of events that we want to indicate for possible future filtering.
    SELECT distinct lower(topic) as topic, description, category
    FROM (values
         ('0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925', 'ERC20 Approval', 'Approval')
        ,('0x17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c31', 'ERC721/ERC1155 Approval', 'Approval')

        ,('0xe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c', 'WETH Wrap', 'Wrapping')
        ,('0x7fcf532c15f0a6db0bd6d0e038bea71d30d808c7d98cb3bf7268a95bf5081b65', 'WETH Unwrap', 'Wrapping')

        ,('0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', 'ERC20/ERC721 Transfer', 'Transfer')
        ,('0xc3d58168c5ae7397731d063d5bbf3d657854427343f4c083240f7aacaa2d0f62', 'ERC1155 Transfer Single', 'Transfer')
        ,('0x4a39dc06d4c0dbc64b70af90fd698a233a518aa5d07e595d983b8c0526c8f7fb', 'ERC1155 Transfer Batch', 'Transfer')
        ,('0xe6497e3ee548a3372136af2fcb0696db31fc6cf20260707645068bd3fe97f3c4', 'Polygon Log Transfer', 'Transfer')
        ,('0x4dfe1bbbcf077ddc3e01291eea2d5c70c2b422b415d95645b9adcfd678cb1d63', 'Polygon Log Fee Transfer', 'Transfer')
        ) a (topic, description, category)
)

-- Select the columns for joining back to transactions and sum event types
-- Calculate types of events emitted for downstream "qualified transaction" filtering

SELECT
        l.dt
        ,epoch_to_hour(l.block_timestamp) AS block_hour
        ,l.block_timestamp
        ,l.network, l.chain, l.chain_id
        ,l.block_number
        ,l.transaction_hash
        ,t.transaction_index
        ,t.transaction_type

        ,COUNT(*) AS count_total_events
        ,SUM(CASE WHEN f.category = 'Approval' THEN 1 ELSE 0 END) AS count_approval_events
        ,SUM(CASE WHEN f.category = 'Wrapping' THEN 1 ELSE 0 END) AS count_wrapping_events
        ,SUM(CASE WHEN f.category = 'Transfer' THEN 1 ELSE 0 END) AS count_transfer_events

FROM ingestion_logs_v1 AS l
INNER JOIN ingestion_transactions_v1 AS t 
        ON l.block_number = t.block_number
        AND l.transaction_index = t.transaction_index 
        AND l.transaction_hash = t.hash
LEFT JOIN topic0_filters AS f
        ON l.topic0 = f.topic

GROUP BY 1,2,3,4,5,6,7,8,9,10


